<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Principal - Be Gestion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin-estilos.css">
</head>
<body>
    <div class="container">
        <h1>Men√∫ Principal</h1>
        <p>Bienvenido, <span id="user-name">Usuario</span>.</p>
        
        <div id="ranking-container" class="ranking-card">
        </div>

        <div id="visit-ranking-container" class="ranking-card">
        </div>
        
        <div id="follow-up-ranking-container" class="ranking-card">
        </div>
        
        <div id="performance-container" class="ranking-card">
        </div>
        
        <nav class="nav-grid" id="menu-buttons-container">
        </nav>
        
        <a href="#" id="logout-btn" class="back-link" style="margin-top: 20px;">Cerrar Sesi√≥n</a>
    </div>

    <div id="coordinator-panel" class="container mt-5" style="display: none;">
        <h2 class="text-center mb-4">Panel de Desempe√±o del Equipo</h2>
        <div class="row text-center">
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">üéØ Tasa de Cierre del Equipo</h5>
                        <p class="display-4 fw-bold" id="team-closing-rate">--%</p>
                        <small class="text-muted">(Formalizaciones / Total de Visitas)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">‚è±Ô∏è Promedio de Seguimiento del Equipo</h5>
                        <p class="display-4 fw-bold" id="team-follow-up-average">-- d√≠as</p>
                        <small class="text-muted">(Promedio de tiempo sin visitar a un prospecto activo)</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        üìà Ranking Interno del Equipo (Basado en D√≠as de Seguimiento)
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                            <div>
                                <strong class="text-success">üèÜ Asesor Destacado (Menor tiempo)</strong>
                                <p class="mb-0" id="top-performer-name">Cargando...</p>
                            </div>
                            <span class="badge bg-success rounded-pill fs-6" id="top-performer-days">--</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                            <div>
                                <strong class="text-warning">üõ†Ô∏è Asesor con Oportunidad (Mayor tiempo)</strong>
                                <p class="mb-0" id="improvement-opportunity-name">Cargando...</p>
                            </div>
                            <span class="badge bg-warning rounded-pill fs-6" id="improvement-opportunity-days">--</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userNameSpan = document.getElementById('user-name');
            const menuContainer = document.getElementById('menu-buttons-container');
            const logoutBtn = document.getElementById('logout-btn');

            const menuOptions = {
                'Administrador': [
                    { text: 'Gesti√≥n de Asesores y Visitas', href: 'admin_panel.html' },
                    { text: 'Gesti√≥n de Centros de Estudio', href: 'admin_centros.html' },
                    { text: 'Gesti√≥n de Usuarios', href: 'admin_usuarios.html' },
                    { text: 'Reporte de Visitas', href: 'reporte_visitas.html' },
                    { text: 'Listado de Centros Formalizados', href: 'formalized_centers_list.html' }
                ],
                'Coordinador': [
                    { text: 'Gesti√≥n de Asesores y Visitas', href: 'admin_panel.html' },
                    { text: 'Gesti√≥n de Centros de Estudio', href: 'admin_centros.html' },
                    { text: 'Reporte de Visitas', href: 'reporte_visitas.html' },
                    { text: 'Listado de Centros Formalizados', href: 'formalized_centers_list.html' }
                ],
                'Asesor': [
                    { text: 'Registrar Visita', href: 'registro_visita.html' },
                    { text: 'Solicitar Cotizaci√≥n', href: 'solicitud_cotizacion.html' },
                    { text: 'Ver Mis Cotizaciones', href: 'listado_cotizaciones.html' },
                    { text: 'Listado de Centros Formalizados', href: 'formalized_centers_list.html' }
                ]
            };

            const fetchAndDisplayRanking = async (apiUrl, containerId, title, key, unit) => {
                const container = document.getElementById(containerId);
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();

                    let content = `<h3>${title}</h3>`;
                    if (data.length > 0) {
                        content += '<ol>';
                        data.forEach(item => {
                            const value = parseFloat(item[key]).toFixed(1);
                            content += `<li>${item.advisorname}: <strong>${value} ${unit}</strong></li>`;
                        });
                        content += '</ol>';
                    } else {
                        content += '<p>No hay datos disponibles.</p>';
                    }
                    container.innerHTML = content;
                } catch (error) {
                    console.error(`Error fetching ${title}:`, error);
                    container.innerHTML = `<h3>${title}</h3><p>Error al cargar datos.</p>`;
                }
            };

            const loadCoordinatorPanel = async () => {
                try {
                    const response = await fetch('/api/coordinator/team-performance');
                    if (!response.ok) {
                        throw new Error('No se pudo cargar la data de coordinaci√≥n.');
                    }
                    const data = await response.json();

                    document.getElementById('team-closing-rate').textContent = `${data.teamClosingRate}%`;
                    document.getElementById('team-follow-up-average').textContent = `${data.teamAverageFollowUpDays} d√≠as`;
                    
                    document.getElementById('top-performer-name').textContent = data.topPerformer.name;
                    document.getElementById('top-performer-days').textContent = `${data.topPerformer.days} d√≠as`;
                    
                    document.getElementById('improvement-opportunity-name').textContent = data.improvementOpportunity.name;
                    document.getElementById('improvement-opportunity-days').textContent = `${data.improvementOpportunity.days} d√≠as`;

                } catch (error) {
                    console.error('Error en el panel de coordinadora:', error);
                }
            };
            
            fetch('/api/user-session')
                .then(res => {
                    if (!res.ok) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                })
                .then(user => {
                    if (!user) return;
                    userNameSpan.textContent = user.nombre;

                    const userMenu = menuOptions[user.rol];
                    if (userMenu) {
                        userMenu.forEach(option => {
                            const link = document.createElement('a');
                            link.href = option.href;
                            link.className = 'nav-button';
                            link.textContent = option.text;
                            menuContainer.appendChild(link);
                        });
                    }

                    if (user.rol === 'Administrador') {
                        fetchAndDisplayRanking('/api/advisor-ranking', 'ranking-container', 'Ranking de Formalizaciones', 'formalized_count', 'centros');
                        fetchAndDisplayRanking('/api/advisor-visit-ranking', 'visit-ranking-container', 'Ranking de Visitas Totales', 'visit_count', 'visitas');
                        fetchAndDisplayRanking('/api/advisor-follow-up-ranking', 'follow-up-ranking-container', 'Ranking de Seguimiento (D√≠as Promedio)', 'average_follow_up_days', 'd√≠as');
                        fetchAndDisplayRanking('/api/advisor-performance', 'performance-container', 'Ranking de Desempe√±o', 'performance_score', 'puntos');
                    }
                    
                    if (user.rol === 'Coordinador' || user.rol === 'Administrador') {
                        document.getElementById('coordinator-panel').style.display = 'block';
                        loadCoordinatorPanel();
                    }
                })
                .catch(() => {
                    window.location.href = '/login.html';
                });

            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                fetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login.html';
                    });
            });
        });
    </script>
</body>
</html>
